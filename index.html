<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Happy Birthday — Ava</title>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<meta name="theme-color" content="#1a1635" />
<meta name="description" content="Phone‑first 3D birthday page with BTS purple vibes, tilt & shake magic, haptics, lightstick, sakura, fireworks, and a countdown to Sep 7 — for Ava." />

<!-- Web fonts for KR/JP text rendering -->
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@500;700&family=Noto+Sans+KR:wght@500;700&family=Poppins:wght@600;800&display=swap" rel="stylesheet">

<!-- Three.js via import map -->
<script type="importmap">
{
  "imports": {
    "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
    "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/",
    "react": "https://aistudiocdn.com/react@^19.1.1",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.1.1/",
    "react/": "https://aistudiocdn.com/react@^19.1.1/",
    "three/": "https://aistudiocdn.com/three@^0.180.0/"
  }
}
</script>

<style>
  :root{
    --bg0:#0b0a1a; --bg1:#1a1635;
    --ink:#eee8ff; --muted:#c4bdf2;
    --purple:#8b5cf6; --purple-soft:#a78bfa; --purple-deep:#6d28d9;
    --gold:#f4c430; --panel:#221c48; --panel2:#2d2857; --ok:#10b981;
  }

  /* Animated BTS‑purple background */
  @keyframes skyPulse {
    0%{ background-position: 40% 30%; }
    50%{ background-position: 60% 20%; }
    100%{ background-position: 40% 30%; }
  }
  html,body{height:100%;margin:0;color:var(--ink);
    background: radial-gradient(1200px 700px at 60% 25%, var(--bg1), var(--bg0));
    background-size: 200% 200%; animation: skyPulse 22s ease-in-out infinite;
    font-family:"Poppins","Noto Sans KR","Noto Sans JP",system-ui,Segoe UI,Roboto,Helvetica,Arial;
    overflow:hidden;
  }
  #scene{position:fixed;inset:0}

  /* HUD layout (mobile-first) */
  #hud{position:fixed;inset:0;display:grid;grid-template-rows:auto 1fr auto;pointer-events:none;z-index:12}
  .topbar{
    display:flex;align-items:center;justify-content:space-between;gap:10px;
    padding:10px 14px;
    background:linear-gradient(90deg,rgba(45,40,87,.55),rgba(20,18,40,.35));
    backdrop-filter:blur(8px);
    border-bottom:1px solid rgba(167,139,250,.25);
    pointer-events:auto;
  }
  .brand{display:flex;align-items:center;gap:10px;font-weight:800;letter-spacing:.4px}
  .brand .heart{filter:drop-shadow(0 0 8px rgba(167,139,250,.9))}
  .center{display:grid;place-items:center;text-align:center;padding:10px}
  .title{font-size:clamp(24px,6vw,56px);font-weight:800;line-height:1.05;text-shadow:0 3px 12px rgba(0,0,0,.55)}
  .title .purple{color:var(--purple)}
  .subtitle{margin-top:6px;font-size:clamp(13px,3.6vw,18px);color:var(--muted)}
  .count{display:inline-flex;gap:8px;margin-top:10px;background:rgba(29,25,58,.55);border:1px solid rgba(167,139,250,.35);border-radius:999px;padding:6px 10px;font-weight:700}
  .chip{padding:4px 10px;border-radius:999px;background:rgba(167,139,250,.12)}
  .chip.ok{background:rgba(16,185,129,.15);border:1px solid rgba(16,185,129,.35)}

  /* Bottom fun dock (thumb‑friendly) */
  .dock{
    pointer-events:auto;
    position:relative;
    display:flex; gap:10px; overflow:auto hidden; scrollbar-width:none;
    padding:10px 12px calc(10px + env(safe-area-inset-bottom));
    background:linear-gradient(90deg,rgba(45,40,87,.55),rgba(20,18,40,.35));
    border-top:1px solid rgba(167,139,250,.25);
  }
  .dock::-webkit-scrollbar{display:none}
  .btn{
    flex:0 0 auto;
    background:var(--panel2);
    border:1px solid rgba(167,139,250,.5);
    color:var(--ink);
    border-radius:14px;
    padding:12px 14px;
    font-size:15px; font-weight:800;
    letter-spacing:.2px;
    display:flex;align-items:center;gap:8px;
    cursor:pointer; user-select:none; -webkit-tap-highlight-color: transparent;
    transition:transform .07s ease, background .2s ease;
  }
  .btn:active{transform:translateY(1px) scale(.98)}
  .btn.small{padding:10px 12px;font-size:14px}
  .pill{border-radius:999px}
  .ok{border-color:rgba(16,185,129,.5)}
  .danger{border-color:rgba(244,67,54,.55)}

  .footchips{
    position:fixed;left:12px;bottom:calc(64px + env(safe-area-inset-bottom));z-index:13;
    display:flex;gap:8px;flex-wrap:wrap;max-width:92vw;pointer-events:none;
  }
  .tag{pointer-events:auto;background:rgba(167,139,250,.12);border:1px solid rgba(167,139,250,.35);padding:6px 10px;border-radius:999px;white-space:nowrap;font-weight:700}
  .tag.kr{border-color:rgba(16,185,129,.45)}
  .tag.jp{border-color:rgba(230,0,38,.45)}

  .hint{
    position:fixed;left:50%;transform:translateX(-50%);bottom:calc(120px + env(safe-area-inset-bottom));
    background:rgba(17,14,38,.7);border:1px solid rgba(167,139,250,.4);border-radius:12px;
    padding:8px 12px;font-size:13px;z-index:14;backdrop-filter:blur(6px)
  }
  .credit{position:fixed;right:10px;bottom:calc(12px + env(safe-area-inset-bottom));z-index:11;font-size:12px;opacity:.6;pointer-events:none}

  /* Soft vignette edge */
  .vignette::before{content:"";position:fixed;inset:-10px;pointer-events:none;background:radial-gradient(60% 60% at 50% 50%, transparent 55%, rgba(0,0,0,.22) 100%);z-index:5}

  /* Desktop nicety */
  @media (min-width:900px){ .title{font-size:56px} .btn{font-size:14px} }
</style>
</head>
<body class="vignette">
  <div id="scene" aria-label="3D birthday scene"></div>

  <div id="hud" role="region" aria-label="Overlay">
    <div class="topbar">
      <div class="brand"><span class="heart">💜</span><span>Ava — Birthday</span></div>
      <button id="fsBtn" class="btn small pill" title="Fullscreen">⛶ Fullscreen</button>
    </div>

    <div class="center" aria-live="polite">
      <div class="title">Happy Birthday, <span class="purple">Ava</span>!</div>
      <div class="subtitle">생일 축하해! • お誕生日おめでとう！ • I purple you (보라해)</div>
      <div class="count" aria-label="Countdown to Sep 7">
        <span class="chip"><strong>Target:</strong> Sep 7</span>
        <span class="chip" id="dd">00d</span>
        <span class="chip" id="hh">00h</span>
        <span class="chip" id="mm">00m</span>
        <span class="chip ok" id="ss">00s</span>
      </div>
    </div>

    <!-- Thumb-friendly bottom dock -->
    <div class="dock">
      <button id="armyBtn" class="btn pill" title="Purple ARMY theme">💜 ARMY</button>
      <button id="fireBtn" class="btn pill" title="Fireworks">🎆 Fireworks</button>
      <button id="petalsBtn" class="btn pill" title="Toggle sakura">🌸 Sakura</button>
      <button id="stickBtn" class="btn pill" title="Lightstick">🔦 Lightstick</button>
      <button id="tiltBtn" class="btn pill ok" title="Enable Tilt & Shake">🎮 Enable Tilt/Shake</button>
      <button id="fpsBtn" class="btn pill" title="Performance mode">⚡ FPS Boost</button>
      <button id="chimeBtn" class="btn pill" title="Play chime">🔊 Chime</button>
    </div>
  </div>

  <!-- Cultural tags floating above dock -->
  <div class="footchips">
    <span class="tag kr">🇰🇷 생일 축하해</span>
    <span class="tag jp">🇯🇵 お誕生日おめでとう</span>
    <span class="tag">🫰 보라해</span>
    <span class="tag">🌸 Sakura & Lanterns</span>
    <span class="tag">🎶 K‑Pop energy</span>
  </div>

  <div class="hint" id="hint">Tap, double‑tap, long‑press • Tilt/Shake for more 🎉</div>
  <div class="credit">Fan‑made • Three.js • No lyrics used</div>

<script type="module">
  import * as THREE from 'three';
  import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
  import { FontLoader } from 'three/addons/loaders/FontLoader.js';
  import { TextGeometry } from 'three/addons/geometries/TextGeometry.js';

  // ---------- DOM ----------
  const sceneEl = document.getElementById('scene');
  const armyBtn = document.getElementById('armyBtn');
  const fireBtn = document.getElementById('fireBtn');
  const petalsBtn = document.getElementById('petalsBtn');
  const stickBtn = document.getElementById('stickBtn');
  const tiltBtn = document.getElementById('tiltBtn');
  const fpsBtn = document.getElementById('fpsBtn');
  const chimeBtn = document.getElementById('chimeBtn');
  const fsBtn = document.getElementById('fsBtn');
  const hint = document.getElementById('hint');
  const dd = document.getElementById('dd'), hh = document.getElementById('hh'), mm = document.getElementById('mm'), ss = document.getElementById('ss');

  // Helpers
  const isMobile = /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
  const DPR = Math.min(isMobile ? 1.75 : 2, devicePixelRatio || 1);
  const now = () => new Date().getTime();

  // Haptics
  const buzz = (pattern=20) => { if (navigator.vibrate) navigator.vibrate(pattern); };

  // ---------- Three.js setup ----------
  const scene = new THREE.Scene();
  scene.fog = new THREE.FogExp2(0x0b0a1a, 0.045);

  const renderer = new THREE.WebGLRenderer({ antialias:true, alpha:true, powerPreference:'high-performance' });
  renderer.setPixelRatio(DPR);
  renderer.setSize(innerWidth, innerHeight);
  renderer.outputColorSpace = THREE.SRGBColorSpace;
  renderer.shadowMap.enabled = true;
  renderer.shadowMap.type = THREE.PCFSoftShadowMap;
  sceneEl.appendChild(renderer.domElement);

  const camera = new THREE.PerspectiveCamera(60, innerWidth/innerHeight, 0.1, 200);
  camera.position.set(0, 2.1, 9.2);
  const controls = new OrbitControls(camera, renderer.domElement);
  controls.enableDamping = true;
  controls.maxPolarAngle = Math.PI*0.58;
  controls.minDistance = 4;
  controls.maxDistance = 18;

  // Lights
  const hemi = new THREE.HemisphereLight(0xd6ccff, 0x120e2b, 0.9);
  scene.add(hemi);
  const dir = new THREE.DirectionalLight(0xffffff, 1.0);
  dir.position.set(6, 10, 6);
  dir.castShadow = true;
  dir.shadow.mapSize.set(1024,1024);
  scene.add(dir);
  const fill = new THREE.SpotLight(0x8b5cf6, 0.65, 40, Math.PI/4, 0.5, 1);
  fill.position.set(-6, 7, 5);
  scene.add(fill);

  // Ground
  const ground = new THREE.Mesh(new THREE.CircleGeometry(16,64), new THREE.MeshStandardMaterial({color:0x141233,roughness:0.95}));
  ground.rotation.x = -Math.PI/2;
  ground.receiveShadow = true;
  scene.add(ground);

  // Background stars (reduced for phones)
  const starCount = isMobile ? 900 : 1400;
  const starPos = new Float32Array(starCount*3);
  for(let i=0;i<starCount;i++){
    const r = 60 + Math.random()*80;
    const th = Math.random()*Math.PI*2;
    const ph = Math.acos(2*Math.random()-1);
    starPos[i*3]   = r*Math.sin(ph)*Math.cos(th);
    starPos[i*3+1] = r*Math.cos(ph);
    starPos[i*3+2] = r*Math.sin(ph)*Math.sin(th);
  }
  const stars = new THREE.Points(
    new THREE.BufferGeometry().setAttribute('position', new THREE.BufferAttribute(starPos,3)),
    new THREE.PointsMaterial({size:0.05,color:0xa78bfa,transparent:true,opacity:0.82,depthWrite:false})
  );
  scene.add(stars);

  // Torii gate (stylized)
  const torii = new THREE.Group();
  const vermilion = new THREE.MeshStandardMaterial({ color:0xe63b29, roughness:0.65, metalness:0.05, emissive:0x100100, emissiveIntensity:0.25});
  const pGeo = new THREE.CylinderGeometry(0.22,0.25,4.2,16);
  const xbar = new THREE.Mesh(new THREE.BoxGeometry(6.4,0.25,0.6), vermilion);
  const sbar = new THREE.Mesh(new THREE.BoxGeometry(4.8,0.18,0.5), vermilion);
  const cap  = new THREE.Mesh(new THREE.BoxGeometry(6.8,0.18,0.8), vermilion);
  const L = new THREE.Mesh(pGeo,vermilion); const R = new THREE.Mesh(pGeo,vermilion);
  L.position.set(-2.1,2.1,-7.8); R.position.set(2.1,2.1,-7.8);
  xbar.position.set(0,4.1,-7.8); sbar.position.set(0,3.6,-7.8); cap.position.set(0,4.35,-7.8);
  [L,R].forEach(m=>{m.castShadow=true; m.receiveShadow=true;});
  torii.add(L,R,xbar,sbar,cap); scene.add(torii);

  // Lantern ring
  const lanternGroup = new THREE.Group(); scene.add(lanternGroup);
  const lanterns = []; const lanternCount=10; const lanternRadius=6;
  function makeLantern(angle){
    const g = new THREE.Group();
    const body = new THREE.Mesh(
      new THREE.CylinderGeometry(0.35,0.35,0.9,24,1,true),
      new THREE.MeshStandardMaterial({color:0xfff4d6, emissive:0xffe1a1, emissiveIntensity:0.65, side:THREE.DoubleSide, roughness:0.6})
    );
    const hoopGeo = new THREE.TorusGeometry(0.36,0.03,8,16);
    const hoopMat = new THREE.MeshStandardMaterial({color:0x8b5cf6, roughness:0.4, metalness:0.2});
    const hoopT = new THREE.Mesh(hoopGeo,hoopMat); const hoopB = new THREE.Mesh(hoopGeo,hoopMat);
    hoopT.rotation.x = hoopB.rotation.x = Math.PI/2; hoopT.position.y = 0.48; hoopB.position.y = -0.48;
    const tassel = new THREE.Mesh(new THREE.CylinderGeometry(0.02,0.02,0.5,6), new THREE.MeshStandardMaterial({color:0xa78bfa,emissive:0x3a2a73,emissiveIntensity:0.45}));
    tassel.position.y = -0.95;
    const light = new THREE.PointLight(0xffc58d, 1.0, 6, 2); light.position.set(0,0.1,0);
    g.add(body,hoopT,hoopB,tassel,light);
    const x = Math.cos(angle)*lanternRadius, z = Math.sin(angle)*lanternRadius;
    g.position.set(x,2.6,z); g.lookAt(0,2.0,0); lanternGroup.add(g);
    return {group:g, light, baseY:g.position.y, phase:Math.random()*Math.PI*2};
  }
  for(let i=0;i<lanternCount;i++){ lanterns.push(makeLantern(i/lanternCount*Math.PI*2)); }

  // Heart (BTS-ish purple)
  function createHeart(size=0.95, depth=0.45, color=0x8b5cf6){
    const s = new THREE.Shape();
    s.moveTo(0,0);
    s.bezierCurveTo(0,0,-0.5,-0.5,-1.2,0.1);
    s.bezierCurveTo(-2.2,1.2,-0.8,2.3,0,1.3);
    s.bezierCurveTo(0.8,2.3,2.2,1.2,1.2,0.1);
    s.bezierCurveTo(0.5,-0.5,0,0,0,0);
    const geo = new THREE.ExtrudeGeometry(s,{depth,bevelEnabled:true,bevelSegments:8,steps:2,bevelSize:0.06,bevelThickness:0.06});
    geo.center(); geo.scale(size,size,size);
    const mat = new THREE.MeshStandardMaterial({color, metalness:0.45, roughness:0.15, emissive:0x2f165f, emissiveIntensity:0.28});
    const m = new THREE.Mesh(geo,mat); m.castShadow=true; return m;
  }
  const heart = createHeart(); heart.position.set(0,2.25,0); scene.add(heart);

  // Small heart ring
  const ring = new THREE.Group(); scene.add(ring);
  for(let i=0;i<16;i++){
    const h = createHeart(0.34,0.14,0xa78bfa);
    const a = i/16*Math.PI*2;
    h.position.set(Math.cos(a)*3.1, 2.2 + Math.sin(a*2)*0.25, Math.sin(a)*3.1);
    h.lookAt(0,2.2,0); ring.add(h);
  }

  // 3D Text (EN) + KR/JP billboards
  const loader = new FontLoader();
  const FONT_URL = 'https://cdn.jsdelivr.net/npm/three@0.160.0/examples/fonts/helvetiker_regular.typeface.json';
  function make3DText(text, {size=0.8, height=0.22, color=0xffffff, y=0}={}){
    const mat = new THREE.MeshStandardMaterial({color, roughness:0.35, metalness:0.25, emissive:0x120a2a, emissiveIntensity:0.2});
    const geo = new TextGeometry(text,{font, size, height, curveSegments:12, bevelEnabled:true, bevelThickness:0.015, bevelSize:0.02, bevelSegments:5});
    geo.center();
    const mesh = new THREE.Mesh(geo, mat); mesh.castShadow=true; mesh.position.y = y; return mesh;
  }
  let font;
  loader.load(FONT_URL, (f)=>{
    font = f;
    scene.add(
      make3DText('Happy Birthday!', {size:0.82, height:0.25, y:4.9}),
      make3DText('Ava', {size:1.0, color:0xa78bfa, y:4.0}),
      make3DText('Sep 7', {size:0.5, color:0xf4c430, y:3.2})
    );
  });
  function makeTextBillboard(text, {font='700 64px "Noto Sans KR"', color='#a3e635', y=3.05}={}){
    const dpr = Math.min(2, devicePixelRatio || 1);
    const pad = 28*dpr, hPx = 96*dpr;
    const c = document.createElement('canvas'); const ctx = c.getContext('2d');
    ctx.font = font; const wPx = Math.ceil(ctx.measureText(text).width) + pad*2;
    c.width = wPx; c.height = hPx + pad*2;
    ctx.font = font; ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.shadowColor = color; ctx.shadowBlur = 20*dpr; ctx.fillStyle = color;
    ctx.fillText(text, c.width/2, c.height/2);
    const tex = new THREE.CanvasTexture(c); tex.colorSpace = THREE.SRGBColorSpace;
    const sprite = new THREE.Sprite(new THREE.SpriteMaterial({map:tex, transparent:true, depthWrite:false}));
    const scale = 0.012; sprite.scale.set(c.width*scale, c.height*scale, 1); sprite.position.set(0,y,0); return sprite;
  }
  document.fonts.ready.then(()=>{
    scene.add(
      makeTextBillboard('생일 축하해!', {font:'700 64px "Noto Sans KR"', color:'#a3e635', y:2.5}),
      makeTextBillboard('お誕生日おめでとう！', {font:'700 56px "Noto Sans JP"', color:'#60a5fa', y:1.9})
    );
  });

  // Sakura petals
  let sakuraEnabled = true;
  const petalSprites = []; const basePetalCount = isMobile ? 120 : 180;
  function petalTexture(){
    const c = document.createElement('canvas'); c.width=c.height=128;
    const x = c.getContext('2d'); x.clearRect(0,0,128,128); x.translate(64,72); x.rotate(-0.25);
    const g = x.createRadialGradient(0,0,5, 0,0,60);
    g.addColorStop(0,'rgba(255,214,235,.95)'); g.addColorStop(1,'rgba(238,125,189,.08)');
    x.fillStyle=g; x.beginPath(); x.moveTo(0,-48); x.quadraticCurveTo(26,-26,0,48); x.quadraticCurveTo(-26,-26,0,-48); x.fill();
    return new THREE.CanvasTexture(c);
  }
  const petalTex = petalTexture();
  const petalMat = new THREE.SpriteMaterial({ map:petalTex, transparent:true, depthWrite:false, opacity:0.9 });
  function spawnPetal(){
    const s = new THREE.Sprite(petalMat.clone());
    s.scale.setScalar(0.6 + Math.random()*0.9);
    s.position.set((Math.random()-0.5)*16, 6 + Math.random()*6, (Math.random()-0.5)*16);
    s.userData = { vy:-(0.01+Math.random()*0.02), vx:(Math.random()-0.5)*0.01, vz:(Math.random()-0.5)*0.01, rot:Math.random()*Math.PI*2, spin:(Math.random()-0.5)*0.02 };
    petalSprites.push(s); scene.add(s);
  }
  for(let i=0;i<basePetalCount;i++) spawnPetal();

  // Confetti
  const confettiMeshes = [];
  function confettiBurst(center=new THREE.Vector3(0,3.5,0), amount=160){
    const geo = new THREE.PlaneGeometry(0.15,0.15);
    const group = new THREE.Group();
    for(let i=0;i<amount;i++){
      const m = new THREE.Mesh(geo, new THREE.MeshBasicMaterial({side:THREE.DoubleSide, transparent:true, opacity:1, depthWrite:false}));
      m.position.copy(center);
      m.userData.vx = (Math.random()-0.5)*0.25;
      m.userData.vy = Math.random()*0.28 + 0.08;
      m.userData.vz = (Math.random()-0.5)*0.25;
      m.userData.spinX = (Math.random()-0.5)*0.3;
      m.userData.spinY = (Math.random()-0.5)*0.3;
      m.material.color.setHSL(Math.random(), 0.9, 0.55);
      group.add(m); confettiMeshes.push(m);
    }
    scene.add(group);
    buzz(18);
    setTimeout(()=>{ const fade=setInterval(()=>{group.children.forEach(m=>m.material.opacity-=0.04);},40); setTimeout(()=>{clearInterval(fade); scene.remove(group);},1200); },800);
  }

  // Fireworks
  const fireworks = [];
  function firework(origin=new THREE.Vector3((Math.random()-0.5)*8, 5 + Math.random()*3, (Math.random()-0.5)*8), color=new THREE.Color().setHSL(Math.random(),0.85,0.6)){
    const n=240; const pos=new Float32Array(n*3); const vel=new Float32Array(n*3);
    for(let i=0;i<n;i++){
      const th=Math.random()*Math.PI*2, ph=Math.acos(2*Math.random()-1), sp=0.02+Math.random()*0.08;
      const vx=Math.sin(ph)*Math.cos(th)*sp, vy=Math.cos(ph)*sp, vz=Math.sin(ph)*Math.sin(th)*sp;
      pos[i*3]=origin.x; pos[i*3+1]=origin.y; pos[i*3+2]=origin.z;
      vel[i*3]=vx; vel[i*3+1]=vy; vel[i*3+2]=vz;
    }
    const geo=new THREE.BufferGeometry(); geo.setAttribute('position', new THREE.BufferAttribute(pos,3)); geo.setAttribute('velocity', new THREE.BufferAttribute(vel,3));
    const mat=new THREE.PointsMaterial({size:0.08, color, transparent:true, opacity:1, depthWrite:false});
    const pts=new THREE.Points(geo,mat); pts.userData.life=1.0; scene.add(pts); fireworks.push(pts);
    buzz([10,40,20]); // haptic pop
  }

  // ARMY Lightstick (simple model)
  const stick = new THREE.Group();
  const handle = new THREE.Mesh(new THREE.CylinderGeometry(0.12,0.12,1.6,16), new THREE.MeshStandardMaterial({color:0x2d2857, metalness:0.2, roughness:0.6}));
  const collar = new THREE.Mesh(new THREE.TorusGeometry(0.14,0.025,12,24), new THREE.MeshStandardMaterial({color:0x8b5cf6, metalness:0.5, roughness:0.3}));
  collar.rotation.x = Math.PI/2; collar.position.y = 0.8;
  const bulbMat = new THREE.MeshPhysicalMaterial({color:0xffffff, metalness:0.0, roughness:0.25, transmission:0.75, thickness:0.4, transparent:true});
  const bulb = new THREE.Mesh(new THREE.SphereGeometry(0.35, 24, 16), bulbMat);
  bulb.position.y = 1.1;
  const core = new THREE.Mesh(new THREE.SphereGeometry(0.1, 12, 8), new THREE.MeshStandardMaterial({color:0x7c3aed, emissive:0x7c3aed, emissiveIntensity:1.2}));
  core.position.y = 1.1;
  const stickLight = new THREE.PointLight(0x9b7cfa, 1.1, 7, 2); stickLight.position.set(0,1.1,0);
  handle.castShadow = true; bulb.castShadow=false;
  stick.add(handle, collar, bulb, core, stickLight);
  stick.position.set(-1.8, 2.0, 1.2);
  stick.rotation.z = 0.2;
  scene.add(stick);
  let stickOn = true;

  // Interactions (buttons)
  fireBtn.addEventListener('click',()=>firework());
  let army=false;
  armyBtn.addEventListener('click',()=>{
    army=!army;
    document.body.style.background = army ? 'radial-gradient(1200px 700px at 58% 24%, #3b2b7a, #0b0a1a)' : 'radial-gradient(1200px 700px at 60% 25%, #1a1635, #0b0a1a)';
    heart.material.color.set(army ? 0x7c3aed : 0x8b5cf6);
    stars.material.color.set(army ? 0xc4b5fd : 0xa78bfa);
    lanterns.forEach(l=>l.light.color.set(army ? 0xb794f4 : 0xffc58d));
    armyBtn.textContent = army ? '💜 ARMY ✓' : '💜 ARMY';
    buzz(12);
  });
  let sakura=true;
  petalsBtn.addEventListener('click',()=>{
    sakura=!sakura;
    petalSprites.forEach(s=>s.visible=sakura);
    petalsBtn.textContent = sakura ? '🌸 Sakura' : '🌸 Sakura (off)';
    buzz(10);
  });
  stickBtn.addEventListener('click',()=>{
    stickOn = !stickOn;
    stick.visible = stickOn;
    stickBtn.textContent = stickOn ? '🔦 Lightstick' : '🔦 Lightstick (off)';
    buzz(10);
  });
  let perf = false;
  fpsBtn.addEventListener('click',()=>{
    perf=!perf;
    renderer.shadowMap.enabled = !perf;
    stars.material.size = perf ? 0.04 : 0.05;
    petalSprites.forEach((s,i)=>{ s.visible = !perf || i % 2 === 0; });
    fpsBtn.textContent = perf ? '⚡ FPS Boost ✓' : '⚡ FPS Boost';
    buzz(8);
  });
  fsBtn.addEventListener('click', async ()=>{
    const el = document.documentElement;
    try{ if(!document.fullscreenElement){ await el.requestFullscreen?.(); } else { await document.exitFullscreen?.(); } }catch(e){}
  });

  // WebAudio tiny chime (user gesture only)
  let audioCtx = null;
  chimeBtn.addEventListener('click', ()=>{
    if(!audioCtx){ audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }
    const seq = [440,554,659,880]; // A, C#, E, A
    let t = audioCtx.currentTime;
    seq.forEach((f,i)=>{
      const o = audioCtx.createOscillator(), g = audioCtx.createGain();
      o.type='sine'; o.frequency.value=f;
      g.gain.setValueAtTime(0, t);
      g.gain.linearRampToValueAtTime(0.25, t+0.02);
      g.gain.exponentialRampToValueAtTime(0.0001, t+0.28);
      o.connect(g).connect(audioCtx.destination);
      o.start(t); o.stop(t+0.3);
      t += 0.07;
    });
    buzz([10,40,10]);
  });

  // Gestures: tap (confetti), double-tap (heart pulse), long-press (rapid sparkles)
  let lastTap = 0, holdTimer = null, holding = false;
  const raycaster = new THREE.Raycaster(); const pointer = new THREE.Vector2();
  function worldPosFromPointer(e, planeY=3.5){
    const x = (e.clientX/innerWidth)*2 - 1;
    const y = -(e.clientY/innerHeight)*2 + 1;
    pointer.set(x,y); raycaster.setFromCamera(pointer, camera);
    const t = (planeY - raycaster.ray.origin.y)/raycaster.ray.direction.y;
    return raycaster.ray.origin.clone().add(raycaster.ray.direction.clone().multiplyScalar(t));
  }
  function onPointerDown(e){
    const t = now();
    if (t - lastTap < 300){ // double-tap
      heartPulse(); buzz(16);
      lastTap = 0;
    } else {
      lastTap = t;
      // start long press
      holding = true;
      const pos = worldPosFromPointer(e);
      confettiBurst(pos, 140);
      holdTimer = setTimeout(function spawn(){
        if(!holding) return;
        confettiBurst(worldPosFromPointer(e), 90);
        holdTimer = setTimeout(spawn, 220);
      }, 420);
    }
    hint.style.display='none';
  }
  function onPointerUp(){ holding = false; clearTimeout(holdTimer); }
  sceneEl.addEventListener('pointerdown', onPointerDown);
  sceneEl.addEventListener('pointerup', onPointerUp);
  sceneEl.addEventListener('pointercancel', onPointerUp);
  sceneEl.addEventListener('pointerleave', onPointerUp);

  function heartPulse(){
    let t0 = performance.now();
    const startColor = heart.material.color.clone();
    const endColor = new THREE.Color(0x9b7cfa);
    function step(){
      const k = Math.min(1, (performance.now()-t0)/420);
      heart.scale.setScalar(1 + Math.sin(k*Math.PI)*0.18);
      heart.material.color.lerpColors(startColor, endColor, Math.sin(k*Math.PI));
      if(k<1) requestAnimationFrame(step); else heart.scale.setScalar(1), heart.material.color.copy(startColor);
    }
    step();
  }

  // Tilt (parallax) & Shake (fireworks)
  let tiltEnabled = false, lastShake = 0;
  tiltBtn.addEventListener('click', async ()=>{
    function enabled(){
      tiltEnabled = true;
      tiltBtn.textContent = '🎮 Tilt/Shake ✓';
      buzz(10);
    }
    try{
      // iOS 13+ permission flow
      if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function'){
        const r1 = await DeviceMotionEvent.requestPermission(); 
        const r2 = (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function')
          ? await DeviceOrientationEvent.requestPermission() : 'granted';
        if (r1 === 'granted' && r2 === 'granted') enabled();
      } else { enabled(); }
    } catch(e){ /* ignore */ }
  });
  window.addEventListener('deviceorientation', (e)=>{
    if(!tiltEnabled) return;
    // map [-30..30] deg to small offsets
    const yaw = (e.gamma||0) / 45;  // left/right
    const pitch = (e.beta||0) / 60; // forward/back
    camera.position.x = yaw * 1.0;
    camera.position.y = 2.1 + pitch * 0.6;
  }, true);
  window.addEventListener('devicemotion', (e)=>{
    if(!tiltEnabled) return;
    const a = e.accelerationIncludingGravity || e.acceleration || {x:0,y:0,z:0};
    const mag = Math.sqrt((a.x||0)**2 + (a.y||0)**2 + (a.z||0)**2);
    const t = now();
    if (mag > 18 && t - lastShake > 1200){ // shake threshold
      lastShake = t; firework();
    }
  }, true);

  // Countdown to Sep 7
  function nextSep7(){
    const d=new Date(); let y=d.getFullYear(); const tgt=new Date(y,8,7,0,0,0); // Sep=8
    return d>tgt ? new Date(y+1,8,7,0,0,0) : tgt;
  }
  let target = nextSep7();
  function updateCountdown(){
    const d = new Date(); const diff = target - d;
    if(diff<=0){
      dd.textContent='00d'; hh.textContent='00h'; mm.textContent='00m'; ss.textContent='00s';
      if(!updateCountdown.started){
        updateCountdown.started=true;
        for(let i=0;i<4;i++) setTimeout(()=>firework(), i*900);
        setInterval(()=>firework(), 4500);
      }
      return;
    }
    const s = Math.floor(diff/1000);
    const days = Math.floor(s/86400);
    const hours = Math.floor((s%86400)/3600);
    const mins = Math.floor((s%3600)/60);
    const secs = s%60;
    dd.textContent = String(days).padStart(2,'0')+'d';
    hh.textContent = String(hours).padStart(2,'0')+'h';
    mm.textContent = String(mins).padStart(2,'0')+'m';
    ss.textContent = String(secs).padStart(2,'0')+'s';
  }
  updateCountdown(); setInterval(updateCountdown, 1000);

  // Animation loop
  const clock=new THREE.Clock();
  function animate(){
    const t=clock.getElapsedTime(); requestAnimationFrame(animate);
    heart.rotation.y = t*0.5; heart.position.y = 2.25 + Math.sin(t*1.6)*0.06;
    ring.rotation.y = t*0.25;
    lanterns.forEach(l=>{ l.group.position.y = l.baseY + Math.sin(t*1.6 + l.phase)*0.18; });
    stars.rotation.y = t*0.01;

    if(sakuraEnabled){
      petalSprites.forEach(s=>{
        s.userData.rot += s.userData.spin; s.material.rotation = s.userData.rot;
        s.position.x += s.userData.vx + Math.sin(t*0.5 + s.position.y)*0.002;
        s.position.z += s.userData.vz + Math.cos(t*0.6 + s.position.x)*0.002;
        s.position.y += s.userData.vy;
        if(s.position.y < -1){ s.position.y = 7 + Math.random()*4; s.position.x = (Math.random()-0.5)*16; s.position.z = (Math.random()-0.5)*16; }
      });
    }

    confettiMeshes.forEach(m=>{
      m.position.x += m.userData.vx; m.position.y += m.userData.vy; m.position.z += m.userData.vz;
      m.userData.vy -= 0.01;
      m.rotation.x += m.userData.spinX; m.rotation.y += m.userData.spinY;
    });

    for(let i=fireworks.length-1;i>=0;i--){
      const p=fireworks[i]; const pos=p.geometry.getAttribute('position'); const vel=p.geometry.getAttribute('velocity');
      for(let j=0;j<pos.count;j++){
        vel.array[j*3+1] -= 0.0018;
        pos.array[j*3] += vel.array[j*3]; pos.array[j*3+1] += vel.array[j*3+1]; pos.array[j*3+2] += vel.array[j*3+2];
      }
      pos.needsUpdate = true; p.userData.life -= 0.018; p.material.opacity = Math.max(0,p.userData.life);
      if(p.userData.life<=0){ scene.remove(p); fireworks.splice(i,1); }
    }

    controls.update(); renderer.render(scene,camera);
  }
  animate();

  // Resize
  addEventListener('resize', ()=>{
    camera.aspect = innerWidth/innerHeight; camera.updateProjectionMatrix();
    renderer.setSize(innerWidth, innerHeight);
  });

  // Hide hint after a few seconds
  setTimeout(()=>{ hint.style.opacity='0'; setTimeout(()=>{ hint.style.display='none'; }, 600); }, 6000);

  // Friendly safety note
  // Fan-made page. Not affiliated with or endorsed by BTS/Hybe. No lyrics used.
</script>
</body>
</html>
